---
import { getLangFromUrl, useTranslations } from '../../i18n/utils'
import { getPastEvents, getUpcomingEvents } from '../../utils/sanity'
import Button from '../ui/Button.astro'
import Section from '../ui/Section.astro'
import EventCard from './EventCard.astro'

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)

const [upcomingEvents, pastEvents] = await Promise.all([
  getUpcomingEvents(lang),
  getPastEvents(lang),
])

// Show only 5 events initially for each section
const INITIAL_EVENTS_COUNT = 5
const initialUpcomingEvents = upcomingEvents.slice(0, INITIAL_EVENTS_COUNT)
const initialPastEvents = pastEvents.slice(0, INITIAL_EVENTS_COUNT)
---

<Section id='event-manager' bg='background' class='py-16'>
  <div class='max-w-6xl mx-auto space-y-12'>
    <!-- Upcoming Events Section -->
    <div class='space-y-6'>
      <h2 class='text-4xl font-headings font-bold text-primary text-center'>
        {t('event.tabs.upcoming')}
      </h2>
      <div id='upcoming-events' class='space-y-4'>
        {
          initialUpcomingEvents.length > 0 ? (
            initialUpcomingEvents.map((event) => (
              <EventCard lang={lang} event={event} />
            ))
          ) : (
            <div class='text-center py-12'>
              <div class='w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4'>
                <svg
                  class='w-8 h-8 text-gray-400'
                  fill='none'
                  viewBox='0 0 24 24'
                  stroke='currentColor'
                >
                  <path
                    stroke-linecap='round'
                    stroke-linejoin='round'
                    stroke-width='2'
                    d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'
                  />
                </svg>
              </div>
              <p class='text-gray-500 font-medium'>{t('event.no_results')}</p>
            </div>
          )
        }
      </div>
      {
        upcomingEvents.length > INITIAL_EVENTS_COUNT && (
          <div class='text-center pt-4'>
            <Button
              variant='outline'
              id='load-more-upcoming'
              data-offset={INITIAL_EVENTS_COUNT}
              data-total={upcomingEvents.length}
            >
              {t('event.load_more')}
            </Button>
          </div>
        )
      }
    </div>

    <!-- Past Events Section -->
    <div class='space-y-6 pt-12'>
      <h2
        class='text-4xl font-headings font-bold text-secondary-trust text-center'
      >
        {t('event.tabs.past')}
      </h2>
      <div id='past-events' class='space-y-4'>
        {
          initialPastEvents.length > 0 ? (
            initialPastEvents.map((event) => (
              <EventCard lang={lang} event={event} />
            ))
          ) : (
            <div class='text-center py-12'>
              <div class='w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4'>
                <svg
                  class='w-8 h-8 text-gray-400'
                  fill='none'
                  viewBox='0 0 24 24'
                  stroke='currentColor'
                >
                  <path
                    stroke-linecap='round'
                    stroke-linejoin='round'
                    stroke-width='2'
                    d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'
                  />
                </svg>
              </div>
              <p class='text-gray-500 font-medium'>{t('event.no_results')}</p>
            </div>
          )
        }
      </div>
      {
        pastEvents.length > INITIAL_EVENTS_COUNT && (
          <div class='text-center pt-4'>
            <Button
              variant='outline'
              id='load-more-past'
              data-offset={INITIAL_EVENTS_COUNT}
              data-total={pastEvents.length}
            >
              {t('event.load_more')}
            </Button>
          </div>
        )
      }
    </div>
  </div>
</Section>

<script>
  // Load more functionality for upcoming and past events
  const loadMoreUpcoming = document.getElementById(
    'load-more-upcoming'
  ) as HTMLButtonElement
  const loadMorePast = document.getElementById(
    'load-more-past'
  ) as HTMLButtonElement
  const upcomingEventsContainer = document.getElementById('upcoming-events')
  const pastEventsContainer = document.getElementById('past-events')

  const EVENTS_PER_LOAD = 5

  async function loadMoreEvents(type: 'upcoming' | 'past', offset: number) {
    const button = type === 'upcoming' ? loadMoreUpcoming : loadMorePast
    const container =
      type === 'upcoming' ? upcomingEventsContainer : pastEventsContainer

    if (!button || !container) return

    // Show loading state
    button.disabled = true
    button.textContent = 'Loading...'

    try {
      const params = new URLSearchParams()
      const currentLang = window.location.pathname.startsWith('/en')
        ? 'en'
        : 'id'
      params.append('category', type)
      params.append('offset', offset.toString())
      params.append('limit', EVENTS_PER_LOAD.toString())
      params.append('lang', currentLang)

      const response = await fetch(
        `/partials/event-cards-more?${params.toString()}`
      )
      if (!response.ok) throw new Error('Network response was not ok')
      const html = await response.text()

      // Append new events
      container.insertAdjacentHTML('beforeend', html)

      // Update button state
      const newOffset = offset + EVENTS_PER_LOAD
      const total = parseInt(button.dataset.total || '0')

      if (newOffset >= total) {
        // Hide button if no more events
        button.style.display = 'none'
      } else {
        // Update button data and re-enable
        button.dataset.offset = newOffset.toString()
        button.disabled = false
        button.textContent = 'Load More'
      }
    } catch (error) {
      console.error('Error loading more events:', error)
      button.disabled = false
      button.textContent = 'Load More'
    }
  }

  // Load more upcoming events
  loadMoreUpcoming?.addEventListener('click', () => {
    const offset = parseInt(loadMoreUpcoming.dataset.offset || '0')
    loadMoreEvents('upcoming', offset)
  })

  // Load more past events
  loadMorePast?.addEventListener('click', () => {
    const offset = parseInt(loadMorePast.dataset.offset || '0')
    loadMoreEvents('past', offset)
  })
</script>
