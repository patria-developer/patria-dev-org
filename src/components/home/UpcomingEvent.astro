---
import Section from '../ui/Section.astro'
import Button from '../ui/Button.astro'
import { getLangFromUrl, useTranslations } from '../../i18n/utils'
import { getUpcomingEvents } from '../../utils/sanity'

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)

const upcomingEvents = await getUpcomingEvents(lang)
const nextEvent = upcomingEvents[0] // Get the soonest upcoming event

const labelButton =
  nextEvent.status === 'open' ? t('upcoming.register') : nextEvent.status
---

<Section id='upcoming' class='py-24'>
  <div class='flex flex-col md:flex-row justify-between items-end mb-12 gap-6'>
    <div>
      <h2
        class='text-3xl lg:text-4xl font-headings font-bold text-secondary-trust mb-4'
      >
        {t('upcoming.title')}
      </h2>
      <p class='text-gray-600'>{t('upcoming.desc')}</p>
    </div>
    <a
      href='/event'
      class='text-primary font-bold hover:text-primary/90 flex items-center gap-2 group'
    >
      {t('upcoming.cta')}
      <span class='group-hover:translate-x-1 transition-transform'>â†’</span>
    </a>
  </div>

  {
    nextEvent ? (
      <div class='bg-white rounded-3xl overflow-hidden shadow-xl border border-gray-100 grid md:grid-cols-2 group hover:shadow-2xl transition-all duration-300 upcoming-card'>
        <div class='relative h-64 md:h-auto overflow-hidden'>
          <div class='absolute inset-0 bg-primary/20 group-hover:bg-transparent transition-colors z-10' />
          <img
            src={
              nextEvent.image?.asset?.url ||
              'https://images.unsplash.com/photo-1543269865-cbf427effbad?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'
            }
            alt={nextEvent.title}
            class='w-full h-full object-cover group-hover:scale-105 transition-transform duration-700'
          />
          <div class='absolute top-4 left-4 bg-white/90 backdrop-blur px-4 py-2 rounded-lg z-20 font-bold text-secondary-trust text-center shadow-sm'>
            <span class='block text-2xl'>
              {new Date(nextEvent.date).getDate()}
            </span>
            <span class='block text-xs uppercase tracking-wider'>
              {new Date(nextEvent.date).toLocaleString(lang, {
                month: 'short',
              })}
            </span>
          </div>
        </div>
        <div class='p-8 md:p-12 flex flex-col justify-center'>
          <div class='inline-block px-3 py-1 rounded-full bg-blue-100 text-blue-600 text-xs font-bold mb-4 w-fit'>
            {nextEvent.type.toUpperCase()}
          </div>
          <h3 class='text-2xl md:text-3xl font-bold text-secondary-trust mb-4'>
            {nextEvent.title}
          </h3>
          <p class='text-gray-600 mb-6'>{nextEvent.description}</p>

          <div class='space-y-3 mb-8 text-sm text-gray-500'>
            <div class='flex items-center gap-3'>
              <svg
                class='w-5 h-5 text-primary'
                fill='none'
                viewBox='0 0 24 24'
                stroke='currentColor'
              >
                <path
                  stroke-linecap='round'
                  stroke-linejoin='round'
                  stroke-width='2'
                  d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'
                />
              </svg>
              {nextEvent.time}
            </div>
            <div>
              <div class='flex items-center gap-3'>
                <svg
                  class='w-5 h-5 text-primary'
                  fill='none'
                  viewBox='0 0 24 24'
                  stroke='currentColor'
                >
                  <>
                    <path
                      stroke-linecap='round'
                      stroke-linejoin='round'
                      stroke-width='2'
                      d='M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z'
                    />
                    <path
                      stroke-linecap='round'
                      stroke-linejoin='round'
                      stroke-width='2'
                      d='M15 11a3 3 0 11-6 0 3 3 0 016 0z'
                    />
                  </>
                </svg>
                <p class='font-bold text-secondary-trust text-lg'>
                  {nextEvent.locationName}
                </p>
              </div>
              <div class='flex flex-col gap-2 items-start ml-8'>
                {nextEvent.locationAddress && (
                  <p class='text-sm text-gray-500'>
                    {nextEvent.locationAddress}
                  </p>
                )}
                {nextEvent.locationUrl && (
                  <Button
                    variant='secondary'
                    size='sm'
                    href={nextEvent.locationUrl || '#'}
                    target='_blank'
                    rel='noopener noreferrer'
                    class='bg-red-500 text-white'
                  >
                    Maps Location
                  </Button>
                )}
              </div>
            </div>
          </div>

          {nextEvent.status !== 'no_registration_required' && (
            <Button
              variant='primary'
              disabled={nextEvent.status !== 'open'}
              href={nextEvent.registrationLink || '/event'}
            >
              {labelButton}
            </Button>
          )}
        </div>
      </div>
    ) : (
      <div class='bg-gray-50 rounded-3xl p-12 text-center border border-gray-100'>
        <div class='w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm'>
          <svg
            class='w-10 h-10 text-gray-400'
            fill='none'
            viewBox='0 0 24 24'
            stroke='currentColor'
          >
            <path
              stroke-linecap='round'
              stroke-linejoin='round'
              stroke-width='2'
              d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'
            />
          </svg>
        </div>
        <h3 class='text-xl font-bold text-gray-700 mb-2'>
          Belum ada event mendatang
        </h3>
        <p class='text-gray-500 mb-8 max-w-md mx-auto'>
          Saat ini belum ada event yang dijadwalkan. Lihat dokumentasi event
          kami sebelumnya untuk melihat keseruan komunitas.
        </p>
        <Button variant='outline' href='/event?category=past'>
          Lihat Event Sebelumnya
        </Button>
      </div>
    )
  }
</Section>
