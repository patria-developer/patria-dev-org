---
import { Image } from 'astro:assets';
import flagID from '../../assets/icons/flag-indonesia.svg';
import flagUS from '../../assets/icons/flag-us.svg';
import { getLangFromUrl } from '../../i18n/utils';

const currentLang = getLangFromUrl(Astro.url);
---

<div class="relative inline-block text-left">
  <button
    type="button"
    class="inline-flex items-center justify-center w-full px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
    id="lang-menu-button"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <div class="flex items-center gap-2">
      <Image 
        src={currentLang === 'id' ? flagID : flagUS} 
        alt={currentLang === 'id' ? 'Indonesian Flag' : 'US Flag'} 
        class="w-5 h-5 rounded-sm object-cover" 
        id="current-lang-flag"
      />
      <span id="current-lang-label">{currentLang.toUpperCase()}</span>
    </div>
    <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
    </svg>
  </button>

  <div
    class="origin-top-right absolute right-0 mt-2 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50"
    id="lang-menu"
    role="menu"
    aria-orientation="vertical"
    aria-labelledby="lang-menu-button"
    tabindex="-1"
  >
    <div class="py-1" role="none">
      <button
        class="text-gray-700 w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-3 lang-btn"
        role="menuitem"
        tabindex="-1"
        data-lang="id"
      >
        <Image src={flagID} alt="Indonesia" class="w-5 h-5 rounded-sm object-cover" />
        <span>Indonesia</span>
      </button>
      <button
        class="text-gray-700 w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-3 lang-btn"
        role="menuitem"
        tabindex="-1"
        data-lang="en"
      >
        <Image src={flagUS} alt="English" class="w-5 h-5 rounded-sm object-cover" />
        <span>English</span>
      </button>
    </div>
  </div>
</div>

<script>
  import { setLanguage } from '../../store/language';

  declare global {
    interface Window {
      changeLanguage: (lang: 'id' | 'en') => void;
    }
  }

  const menuButton = document.getElementById('lang-menu-button');
  const menu = document.getElementById('lang-menu');

  // Toggle menu visibility
  menuButton?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isExpanded = menuButton.getAttribute('aria-expanded') === 'true';
    menuButton.setAttribute('aria-expanded', (!isExpanded).toString());
    menu?.classList.toggle('hidden');
  });

  // Close menu when clicking outside
  document.addEventListener('click', (event) => {
    if (menu && !menu.contains(event.target as Node) && !menuButton?.contains(event.target as Node)) {
      menu.classList.add('hidden');
      menuButton?.setAttribute('aria-expanded', 'false');
    }
  });

  // Handle language change
  const langButtons = document.querySelectorAll('.lang-btn');
  langButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const lang = btn.getAttribute('data-lang') as 'id' | 'en';
      if (lang) {
        setLanguage(lang);
      }
    });
  });
</script>
