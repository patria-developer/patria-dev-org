---
export const prerender = false;

import EventCard from '../../components/event/EventCard.astro';
import { getLangFromUrl } from '../../i18n/utils';
import { type SanityEvent, getPastEvents, getUpcomingEvents } from '../../utils/sanity';

const lang = getLangFromUrl(Astro.url);
const category = Astro.url.searchParams.get('category') || 'upcoming';
const offset = parseInt(Astro.url.searchParams.get('offset') || '0');
const limit = parseInt(Astro.url.searchParams.get('limit') || '5');

let events: SanityEvent[] = [];

try {
  if (category === 'upcoming') {
    const upcomingEvents = await getUpcomingEvents(lang);
    events = upcomingEvents.slice(offset, offset + limit);
  } else {
    const pastEvents = await getPastEvents(lang);
    events = pastEvents.slice(offset, offset + limit);
  }
} catch (error) {
  console.error('Error fetching events:', error);
  // Fail gracefully, events will be empty
}

// Map to component props
const mappedEvents = events.map(e => ({
  ...e,
  isPast: category === 'past',
  desc: e.description,
  isoDate: e.date
}));
---

{mappedEvents.map((event) => (
  <EventCard lang={lang} event={event} />
))}